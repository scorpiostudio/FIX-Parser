<!doctype html>
<html style="height:100%;width:100%;">
    <head>
        <meta http-equiv="Content-Type" content="text/html" charset="utf-8"/>
        <title>FIX Parser</title>
        <link rel="stylesheet" href='/static/style.css' />
        <script type="text/javascript" src="/static/jquery.min.js"></script>
        <script type="text/javascript" src="/static/main.js"></script>
        <script type="text/javascript">
            function show_time_line(){
                // 清空表格tbody
                $("#header_line_table>tbody").empty();
                // 读取服务端返回的lines
                var lines = {{messages|tojson|safe}};
                var skip_admin_messages_checked = $('#skip_admin_messages').prop('checked');
                var skip_heartbeats_checked = $('#skip_heart_beats').prop('checked');
                var text = ''
                // 追加FIX消息到TimeLine Table
                for(var i=0; i<lines.length;i++)
                {
                    var line = lines[i];
                    text = text + line.raw + '\n'
                    // 是否过滤管理类消息
                    if(skip_admin_messages_checked)
                    {
                        if(line.msgcat == "admin")
                        {
                            continue;
                        }
                    }
                    // 是否过滤心跳消息
                    if(skip_heartbeats_checked)
                    {
                        if(line.message == "Heartbeat")
                        {
                            continue;
                        }
                    }
                    message_td = '<td>' + line.message + "</td>"
                    if(line.msgcat == "admin")
                    {
                        message_td = '<td><span class="Time_Line_Span"  onclick="click_span()" style="background:#CCCCCC">'+ line.message + "</span></td>"
                    }

                    if(line.message == "Reject")
                    {
                        message_td = '<td><span class="Time_Line_Span"  onclick="click_span()" style="background:red">'+ line.message + "</span></td>"
                    }
                    if(line.message == "NewOrderSingle")
                    {
                        message_td = '<td><span class="Time_Line_Span"  onclick="click_span()" style="background:green">'+ line.message + "</span></td>"
                    }
                    var tr = `<tr align='center' height='30' class=tr_${i} data-trid=${i}>` + "<td>" + line.time + "</td>" + "<td>" + line.sender + "</td>"
                    + "<td>" + line.target + "</td>" + message_td + "<td>" + line.client_order_id + "</td>" +
                    "<td style='word-wrap:break-word;word-break:break-all;'>" + line.details + "</td>" + "</tr>";
                    $("#header_line_table").append(tr);
                }
                document.getElementById('input').value = text
                // 交替行颜色设置
                $("tr:odd").addClass("tr_odd");
                $("tr:even").addClass("tr_even");
            }

            function show_fix_message(row) {
                // 清空表格tbody
                $("#fix_message>tbody").empty();
                var messages = {{messages|tojson|safe}};
                // 获取第row行的FIX Message
                var message = messages[row];
                var fields = message.fields;
                var isChecked = $('#skip_common_fields').prop('checked');
                // 追加FIX消息的所有Field到FIX Message Table
                for(var i=0; i<fields.length;i++)
                {
                    // 是否过滤common类字段
                    if(isChecked)
                    {
                        if(fields[i].is_common_field == 'True')
                        {
                           continue;
                        }
                    }
                    var tag_name = "<td>" + fields[i].tag_name + "</td>";
                    if(fields[i].is_common_field == 'True')
                    {
                        tag_name = '<td><span style="background-color:#CCCCCC">' + fields[i].tag_name + "</span></td>";
                    }
                    var tr = "<tr align='center' height='30'>" + "<td>" + fields[i].tag +
                    "</td>" + tag_name + "<td>" + fields[i].value + "</td>" +
                    "<td style='word-wrap:break-word;word-break:break-all;'>" + fields[i].value_description + "</td>" + "</tr>";
                    $("#fix_message").append(tr);
                }
                // 交替行颜色设置
                $("tr:odd").addClass("tr_odd");
                $("tr:even").addClass("tr_even");
            }
            // 上传文件处理
            function handleFileSelect(event) {
                let reads = new FileReader();
                let file = document.getElementById('fix_file').files[0];
                reads.readAsText(file, 'utf-8');
                // 加载完成时设置input输入框的值
                reads.onload = function (e) {
                    document.getElementById('input').value = e.target.result
                    $('#input_form').submit();
                };
                $("#fix_file").val("");
            }
            // 显示FIX协议版本选择
            function show_fix_versions(){
                $('#standard_fix').empty();
                var standard_fix_list = {{standard_fix_list|tojson|safe}};
                for(let i = 0; i < standard_fix_list.length; i++)
                {
                    var option = $("<option>").val(standard_fix_list[i]).text(standard_fix_list[i]);
                    $("#standard_fix").append(option);
                }
                $('#custom_fix').empty();
                var custom_fix_list = {{custom_fix_list|tojson|safe}};
                for(let i = 0; i < custom_fix_list.length; i++)
                {
                    var option = $("<option>").val(custom_fix_list[i]).text(custom_fix_list[i]);
                    $("#custom_fix").append(option);
                }
            }
        </script>
    </head>

    <body>
        <div class="left"></div>
        <div class="main">
            <div class="input">
                <b style="color:red;font-size:30px;">Paste FIX messages below.</b>
                <form id="input_form" name="input_form" method="post">
                    <textarea id="input" name="input" placeholder="Paste FIX messages text below."
                            type="text" rows="10" style="width: 100%; height: 15%;font-size:16px;background-color:#C7EDCC;">
                    </textarea>
                    <select id="fix_version_select" name="fix_version_select" form="input_form" onChange='javascript:submit();' style="height:30px;">
                        <option value="auto" selected="selected">AutoDetect</option>
                        <optgroup id="standard_fix" label="Standard FIX">
                        </optgroup>
                        <optgroup id="custom_fix" label="Custom FIX">
                        </optgroup>
                    </select>
                    <button style="height:30px;" id="process" form="input_form" type="submit">Process</button>
                    <button style="height:30px;" id="clear" type = "button">Clear</button>
                    <button style="height:30px;" id="sample_data" type="button">Sample Data</button>
                    <input type="file" id="fix_file" size="0px" accept="text/plain" onchange="handleFileSelect(event)"  style="display:none"/>
                    <button style="height:30px;" id="upload_file" type="button" onclick="fix_file.click()">Upload File</button>
                </form>
                {{ dropzone.load_css() }}
                {{ dropzone.load_js() }}
                {{ dropzone.create(action='/upload') }}
                <p></p>
            </div>
            <div class="result">
                <!--Time Line Table-->
                <div class="HeaderLine" style="float:left; width:58%;">
                    <table id="header_line_table" class="sansserif" width="100%" border="0" cellspacing="0" cellpadding="0" align="center">
                        <b style="font-size:25px;">Time Line</b><br>
                        <input id="skip_admin_messages" type="checkbox" name="skip_admin_messages" style="font-size:20px;"/>
                        <label for="skip_admin_messages" style="height:40px;font-size:20px;">Skip Admin Messages</label>
                        <input id="skip_heart_beats" type="checkbox" name="skip_heart_beats" style="font-size:20px;"/>
                        <label for="skip_heart_beats" style="height:40px;font-size:20px;">Skip Heart Beats</label>
                        <thead height="40px" style="font-size:20px;">
                            <th>Time</th>
                            <th>Sender</th>
                            <th>Target</th>
                            <th>Message</th>
                            <th>Client Order ID</th>
                            <th>Details</th>
                        </thead>
                        <tbody class="class_tbody" style="font-size:16px;">
                            <script type="text/javascript">
                                show_time_line();
                                // 设置第1行为当前行
                                $("#header_line_table tr:eq(1)").toggleClass("focus");
                            </script>
                        </tbody>
                    </table>
                </div>
                <div class="" style="width:2%;"></div>
                <!--FIX Message Table-->
                <div class="FixMessage" style="float:right; width:40%;">
                    <table id="fix_message" name="fix_message" class="FixMessage" width="100%" border="0" cellspacing="0" cellpadding="0" align="center">
                        <b style="font-size:25px;">FIX Message Details</b><br>
                        <label style="height:40px;font-size:20px;"><input type="checkbox" id="skip_common_fields" value="" />Skip Common Fields</label>
                        <thead height="40px" style="font-size:20px;">
                            <th>Tag</th>
                            <th>Tag Description</th>
                            <th>Value</th>
                            <th>Value Description</th>
                        </thead>
                        <tbody style="font-size:16px;">
                            <script>
                                show_fix_message(0)
                            </script>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="right"></div>
    </body>
    <style type="text/css">
    </style>
    <script type="text/javascript">
        $(document).ready(function(){
            $("tr:odd").addClass("tr_odd");
            $("tr:even").addClass("tr_even");
            var fix_version = {{fix_version|tojson|safe}};
            show_fix_versions();
            $("#fix_version_select").val(fix_version);
        })

        var row = 0;
        const selectEvent = (ele) => {
            let target = event.target
        }

        $('.class_tbody').click(() => {
            let target = event.target.parentElement
            let focusEle = $(target).parent().find("tr.focus")
            focusEle.toggleClass("focus");
            focusEle.unbind('click')
            let trId = target.dataset.trid
            let ele = $(`.tr_${trId}`)
            ele.click(selectEvent(event))

            ele.toggleClass("focus");
            row = trId
            show_fix_message(row);
        })

        function click_span(){
            let target = event.target.parentElement.parentElement
            let focusEle = $(target).parent().find("tr.focus")
            focusEle.toggleClass("focus");
            focusEle.unbind('click')

            let trId = target.dataset.trid
            let ele = $(`.tr_${trId}`)
            ele.click(selectEvent(event))

            ele.toggleClass("focus");
            row = trId
            show_fix_message(row);
            // 阻止事件向上传播
            event.stopPropagation();
        }

        // 点击Time Line表格的skip_admin_messages复选框
        $("#skip_admin_messages").click(function() {
            show_time_line();
            $("#header_line_table tr:eq(1)").toggleClass("focus");
            show_fix_message(0);
        });

        // 点击Time Line表格的skip_heart_beats复选框
        $("#skip_heart_beats").change(function() {
            show_time_line();
            $("#header_line_table tr:eq(1)").toggleClass("focus");
            show_fix_message(0);
        });

        // 点击FIX Message表格的skipCommonFields复选框
        $("#skip_common_fields").change(function() {
            show_fix_message(row);
        });

        $('#process').click(function() {
            $('#input_from').submit();
        });

        $("#clear").click(function(){
            document.getElementById("input").value = ""
            $("#header_line_table>tbody").empty();
            $("#fix_message>tbody").empty();
        })

        var SAMPLE_FIX_MESSAGES = "8=FIX.4.19=6135=A34=149=EXEC52=20121105-23:24:0656=BANZAI98=0108=3010=003\
            8=FIX.4.19=6135=A34=149=BANZAI52=20121105-23:24:0656=EXEC98=0108=3010=003\
            8=FIX.4.19=4935=034=249=BANZAI52=20121105-23:24:3756=EXEC10=228\
            8=FIX.4.19=4935=034=249=EXEC52=20121105-23:24:3756=BANZAI10=228\
            8=FIX.4.19=10335=D34=349=BANZAI52=20121105-23:24:4256=EXEC11=135215788257721=138=1000040=154=155=MSFT59=010=062\
            8=FIX.4.19=13935=834=349=EXEC52=20121105-23:24:4256=BANZAI6=011=135215788257714=017=120=031=032=037=138=1000039=054=155=MSFT150=2151=010=059\
            8=FIX.4.19=15335=834=449=EXEC52=20121105-23:24:4256=BANZAI6=12.311=135215788257714=1000017=220=031=12.332=1000037=238=1000039=254=155=MSFT150=2151=010=230\
            8=FIX.4.19=10335=D34=449=BANZAI52=20121105-23:24:5556=EXEC11=135215789503221=138=1000040=154=155=ORCL59=010=047\
            8=FIX.4.19=13935=834=549=EXEC52=20121105-23:24:5556=BANZAI6=011=135215789503214=017=320=031=032=037=338=1000039=054=155=ORCL150=2151=010=049\
            8=FIX.4.19=15335=834=649=EXEC52=20121105-23:24:5556=BANZAI6=12.311=135215789503214=1000017=420=031=12.332=1000037=438=1000039=254=155=ORCL150=2151=010=220\
            8=FIX.4.19=10835=D34=549=BANZAI52=20121105-23:25:1256=EXEC11=135215791235721=138=1000040=244=1054=155=SPY59=010=003\
            8=FIX.4.19=13835=834=749=EXEC52=20121105-23:25:1256=BANZAI6=011=135215791235714=017=520=031=032=037=538=1000039=054=155=SPY150=2151=010=252\
            8=FIX.4.19=10435=F34=649=BANZAI52=20121105-23:25:1656=EXEC11=135215791643738=1000041=135215791235754=155=SPY10=198\
            8=FIX.4.19=8235=334=849=EXEC52=20121105-23:25:1656=BANZAI45=658=Unsupported message type10=000\
            8=FIX.4.19=10435=F34=749=BANZAI52=20121105-23:25:2556=EXEC11=135215792530938=1000041=135215791235754=155=SPY10=197\
            8=FIX.4.19=8235=334=949=EXEC52=20121105-23:25:2556=BANZAI45=758=Unsupported message type10=002\
            8=FIX.4.19=6135=A49=INVMGR56=BRKR34=152=20000426-12:05:0698=0108=3010=157\
            8=FIX.4.1,9=61,35=A,49=INVMGR,56=BRKR,34=1,52=20000426-12:05:06,98=0,108=30,10=157,\
            8=FIX.4.2|9=157|35=V|34=2|49=BRKR|52=20120921-06:41:04.295|56=QUOTE1-T|262=1:TOP:EURUSD|263=1|264=1|265=0|266=Y|146=1|55=EUR/USD|460=4|267=2|269=0|269=1|10=170|\
            8=FIX.4.3;9=61;35=A;49=BRKR;56=INVMGR;98=0;34=1;52=20000426-12:05:08;108=30;10=143;\
            8=FIX.4.4^A9=61^A35=A^A49=BRKR^A56=INVMGR^A98=0^A34=1^A52=20000426-12:05:08^A108=30^A10=143^A";

        // Sample Data按钮点击事件处理函数
        $("#sample_data").click(function(){
            document.getElementById("input").value = SAMPLE_FIX_MESSAGES;
            $('#input_form').submit();
        });
    </script>
</html>

